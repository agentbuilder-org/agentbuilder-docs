---
title: "Virtual Modules"
description: "How AgentBuilder's auto-discovery system works with virtual modules and HMR support"
---

## Overview

AgentBuilder uses Vite's virtual module system to automatically discover and load your agent configurations, prompts, tools, and API routes. This eliminates manual registration and provides Hot Module Replacement (HMR) during development.

<Card title="How it works" icon="wand-magic-sparkles">
The Vite plugin scans your project directories at build time and generates virtual modules with dynamic imports. When you add, modify, or delete files, HMR updates the modules automatically—no server restart required.
</Card>

## Virtual Module Exports

The plugin generates several virtual modules that your code can import:

### `virtual:@agentbuilder/vite`

Main consolidated module with all runtime components:

```typescript
import {
  router,              // Request router with built-in + custom routes
  DurableThread,       // Thread Durable Object class
  DurableAgentBuilder, // Singleton Durable Object class
} from 'virtual:@agentbuilder/vite'
```

**Usage in server entry:**

```typescript
import { router } from 'virtual:@agentbuilder/vite'

export default {
  async fetch(request, env) {
    const response = await router(request, env)
    return response ?? new Response(null, { status: 404 })
  }
}
```

### `virtual:@agentbuilder-agents`

Registry of all agent definitions:

```typescript
// Generated module content
export default {
  support_agent: () => import('../agentbuilder/agents/support_agent.ts'),
  chat_agent: () => import('../agentbuilder/agents/chat_agent.ts'),
  // ... more agents
}
```

**Internal usage:**

```typescript
import agents from 'virtual:@agentbuilder-agents'

// Load agent dynamically
const agentModule = await agents['support_agent']()
const agent = agentModule.default
```

### `virtual:@agentbuilder-prompts`

Registry of all prompt definitions:

```typescript
// Generated module content
export default {
  support_prompt: () => import('../agentbuilder/prompts/support_prompt.ts'),
  chat_prompt: () => import('../agentbuilder/prompts/chat_prompt.ts'),
  // ... more prompts
}
```

### `virtual:@agentbuilder-models`

Registry of all model definitions:

```typescript
// Generated module content
export default {
  'gpt-4o': () => import('../agentbuilder/models/gpt-4o.ts'),
  'claude-3-opus': () => import('../agentbuilder/models/claude-3-opus.ts'),
  // ... more models
}
```

### `virtual:agent-tools`

Registry of all tool definitions:

```typescript
// Generated module content
export default {
  search_kb: () => import('../agentbuilder/tools/search_kb.ts'),
  create_ticket: () => import('../agentbuilder/tools/create_ticket.ts'),
  // ... more tools
}
```

### `virtual:agent-hooks`

Registry of all lifecycle hooks:

```typescript
// Generated module content
export default {
  beforeMessage: () => import('../agentbuilder/hooks/beforeMessage.ts'),
  afterMessage: () => import('../agentbuilder/hooks/afterMessage.ts'),
  // ... more hooks
}
```

### `virtual:agent-routes`

Combined registry of built-in and custom API routes:

```typescript
// Generated module content
export default [
  {
    path: '/api/threads',
    method: 'GET',
    handler: () => import('../src/api/threads/index.get.ts')
  },
  {
    path: '/api/threads/:id/messages',
    method: 'POST',
    handler: () => import('../src/api/threads/[id]/messages.post.ts')
  },
  {
    path: '/api/custom',
    method: 'GET',
    handler: () => import('../agentbuilder/api/custom.get.ts')
  },
  // ... more routes
]
```

## Auto-Discovery Process

### How Scanning Works

<Steps>
  <Step title="Plugin initialization">
    When Vite starts, the AgentBuilder plugin reads your configuration:
    ```typescript
    agentbuilder({
      agentsDir: 'agentbuilder/agents',
      promptsDir: 'agentbuilder/prompts',
      // ... other directories
    })
    ```
  </Step>

  <Step title="Directory scanning">
    The plugin scans each configured directory for `.ts` and `.js` files:
    ```
    agentbuilder/
    ├── agents/
    │   ├── support_agent.ts  ✓ Found
    │   └── chat_agent.ts     ✓ Found
    ├── prompts/
    │   └── support_prompt.ts ✓ Found
    └── tools/
        └── search_kb.ts      ✓ Found
    ```
  </Step>

  <Step title="Module generation">
    For each file, the plugin generates a dynamic import entry:
    ```typescript
    export default {
      support_agent: () => import('../agentbuilder/agents/support_agent.ts'),
      // File name becomes the key (without extension)
    }
    ```
  </Step>

  <Step title="Virtual module serving">
    When your code imports a virtual module, Vite serves the generated content:
    ```typescript
    import agents from 'virtual:@agentbuilder-agents'
    // Vite serves the dynamically generated registry
    ```
  </Step>
</Steps>

### File Naming Conventions

<Tabs>
  <Tab title="Agents">
    **File name:** `support_agent.ts`
    **Export name:** `support_agent`
    **Convention:** `snake_case` preferred

    ```typescript
    // agentbuilder/agents/support_agent.ts
    import { defineAgent } from '@agentbuilder/vite'

    export default defineAgent({
      name: 'support_agent', // Must match file name
      // ... config
    })
    ```
  </Tab>

  <Tab title="Prompts">
    **File name:** `support_prompt.ts`
    **Export name:** `support_prompt`
    **Convention:** `snake_case` preferred

    ```typescript
    // agentbuilder/prompts/support_prompt.ts
    import { definePrompt } from '@agentbuilder/vite'

    export default definePrompt({
      name: 'support_prompt', // Must match file name
      // ... config
    })
    ```
  </Tab>

  <Tab title="Tools">
    **File name:** `search_kb.ts`
    **Export name:** `search_kb`
    **Convention:** `snake_case` required

    ```typescript
    // agentbuilder/tools/search_kb.ts
    import { defineTool } from '@agentbuilder/vite'
    import { z } from 'zod'

    export default defineTool(
      'Search knowledge base',
      z.object({ query: z.string() }),
      async (flow, args) => {
        // Implementation
      }
    )
    ```

    <Warning>
    Tool names MUST use `snake_case`. The plugin will warn about non-conforming names.
    </Warning>
  </Tab>

  <Tab title="API Routes">
    **File name:** `custom.get.ts`
    **Route:** `GET /api/custom`
    **Convention:** `{name}.{method}.ts`

    Methods: `get`, `post`, `put`, `delete`, `patch`

    ```typescript
    // agentbuilder/api/custom.get.ts
    import { defineController } from '@agentbuilder/vite'

    export default defineController(async (request, env) => {
      return new Response('Custom endpoint')
    })
    ```

    **Nested routes:**
    ```
    agentbuilder/api/
    ├── custom.get.ts           → GET /api/custom
    ├── threads/
    │   └── [id]/
    │       └── custom.get.ts  → GET /api/threads/:id/custom
    ```
  </Tab>
</Tabs>

## Hot Module Replacement (HMR)

During development, changes are hot-reloaded automatically:

<AccordionGroup>
  <Accordion title="Adding a new agent">
    1. Create `agentbuilder/agents/new_agent.ts`
    2. Plugin detects the new file
    3. Virtual module updates with new entry
    4. Framework can load the agent immediately
    5. **No server restart required**
  </Accordion>

  <Accordion title="Modifying a prompt">
    1. Edit `agentbuilder/prompts/support_prompt.ts`
    2. HMR updates the module
    3. Next request uses the updated prompt
    4. **No server restart required**
  </Accordion>

  <Accordion title="Deleting a tool">
    1. Delete `agentbuilder/tools/old_tool.ts`
    2. Virtual module removes the entry
    3. Tool no longer available to agents
    4. **No server restart required**
  </Accordion>
</AccordionGroup>

## Configuration Options

Customize directory paths in your Vite config:

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import { agentbuilder } from '@agentbuilder/vite'

export default defineConfig({
  plugins: [
    agentbuilder({
      agentsDir: 'agentbuilder/agents',      // Default
      promptsDir: 'agentbuilder/prompts',    // Default
      modelsDir: 'agentbuilder/models',      // Default
      toolsDir: 'agentbuilder/tools',        // Default
      hooksDir: 'agentbuilder/hooks',        // Default
      apiDir: 'agentbuilder/api',            // Default
    }),
  ]
})
```

**Custom directory example:**

```typescript
agentbuilder({
  toolsDir: 'src/my-tools',  // Use custom directory
  // ... other defaults
})
```

## Type Generation

### For Virtual Modules

TypeScript types for virtual modules are generated automatically, but you need to run:

```bash
pnpm cf-typegen
```

This creates `worker-configuration.d.ts` with module declarations:

```typescript
declare module 'virtual:@agentbuilder/vite' {
  export const router: (request: Request, env: Env) => Promise<Response | null>
  export class DurableThread extends DurableObject<Env> {}
  export class DurableAgentBuilder extends DurableObject<Env> {}
}

declare module 'virtual:@agentbuilder-agents' {
  const agents: Record<string, () => Promise<{ default: Agent }>>
  export default agents
}

// ... more declarations
```

### For Your Definitions

When you create agent/prompt/tool files, use the provided types:

```typescript
import { defineAgent, type Agent } from '@agentbuilder/vite'

const myAgent: Agent = defineAgent({
  name: 'my_agent',
  type: 'ai_human',
  // TypeScript validates configuration
})

export default myAgent
```

## Validation and Warnings

The plugin validates your configuration and warns about issues:

### Tool Naming Validation

```typescript
// ❌ Warning: non-standard naming
// agentbuilder/tools/SearchKB.ts
export default defineTool(...)
// Console: "Warning: Tool 'SearchKB' should use snake_case naming"

// ✅ Correct: snake_case naming
// agentbuilder/tools/search_kb.ts
export default defineTool(...)
```

### Duplicate Name Detection

```typescript
// ❌ Warning: duplicate names across tools/prompts/agents
// agentbuilder/tools/search.ts
// agentbuilder/prompts/search.ts
// Console: "Warning: Duplicate name 'search' found in tools and prompts"
```

### Missing Default Export

```typescript
// ❌ Error: no default export
// agentbuilder/agents/my_agent.ts
export const agent = defineAgent({...})  // Wrong!

// ✅ Correct: default export
export default defineAgent({...})
```

## Debugging Virtual Modules

### View Generated Module Content

You can inspect what the plugin generates:

```bash
# Start dev server with debug output
DEBUG=vite:* pnpm dev
```

### Manual Import Test

Test if a virtual module is working:

```typescript
// In any server file
import agents from 'virtual:@agentbuilder-agents'

console.log('Available agents:', Object.keys(agents))
```

### Check Module Resolution

```bash
# Verify module exists in Vite's module graph
curl http://localhost:5173/__inspect/
```

## Limitations

<AccordionGroup>
  <Accordion title="No nested directories for tools">
    Tools must be directly in the `toolsDir`, not in subdirectories:

    ```
    ✅ agentbuilder/tools/search_kb.ts
    ❌ agentbuilder/tools/search/kb.ts
    ```
  </Accordion>

  <Accordion title="File name must match exported name">
    The file name (without extension) becomes the registry key:

    ```typescript
    // ❌ Mismatch
    // File: agentbuilder/agents/support.ts
    export default defineAgent({
      name: 'support_agent', // Different from file name!
    })

    // ✅ Correct
    // File: agentbuilder/agents/support_agent.ts
    export default defineAgent({
      name: 'support_agent', // Matches file name
    })
    ```
  </Accordion>

  <Accordion title="Only .ts and .js files are scanned">
    Other file types are ignored:

    ```
    ✅ my_tool.ts
    ✅ my_tool.js
    ❌ my_tool.tsx
    ❌ my_tool.json
    ❌ README.md
    ```
  </Accordion>
</AccordionGroup>

## Best Practices

<CardGroup cols={2}>
  <Card title="Use snake_case consistently" icon="snake">
    Stick to `snake_case` for all agents, prompts, and tools for consistency with the LLM's tool calling format.
  </Card>

  <Card title="One export per file" icon="file-code">
    Each file should have exactly one default export matching the file name.
  </Card>

  <Card title="Organize by type" icon="folder">
    Keep agents, prompts, tools, and hooks in their respective directories for clear organization.
  </Card>

  <Card title="Use descriptive names" icon="tag">
    File names become API identifiers, so use clear, descriptive names: `search_knowledge_base` not `search`.
  </Card>
</CardGroup>

## Related Documentation

<CardGroup cols={2}>
  <Card title="Builder Overview" icon="cube" href="/packages/builder/overview">
    Core framework documentation
  </Card>
  <Card title="Durable Objects" icon="database" href="/packages/builder/durable-objects">
    Learn about state management
  </Card>
  <Card title="Agents Guide" icon="robot" href="/core/agents">
    Creating agent definitions
  </Card>
  <Card title="Tools Guide" icon="wrench" href="/core/tools">
    Building custom tools
  </Card>
</CardGroup>
